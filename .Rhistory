}
return(df)
}
prec <- lstodf(prec)
tmin <- lstodf(tmin)
tmax <- lstodf(tmax)
x <- prec[[2]]
substr(x, 63,64)
x <- prec[[2]]
x <- yearly_prec[[2]]
substr(x, 63,64)
substr(x, 62,63)
substr(x, 58,61)
substr(x, 57,60)
if(climvar %in% c("prec","tmax")) {
month <- as.numeric(substr(x, 62,63))
year <- as.numeric(substr(x, 57,60))
}
x <- yearly_prec[[2]]
climvar <- "prec"
if(climvar %in% c("prec","tmax")) {
month <- as.numeric(substr(x, 62,63))
year <- as.numeric(substr(x, 57,60))
}
rasttodf <- function(x, dam, climvar = climvar) {
if(climvar == "ndvi"){
month <- as.numeric(substr(x, 94,95))
year <- as.numeric(substr(x, 90,93))
}
if(climvar %in% c("prec","tmax")) {
month <- as.numeric(substr(x, 62,63))
year <- as.numeric(substr(x, 57,60))
}
if(climvar != "tmax") {
month <- as.numeric(substr(x, 63,64))
year <- as.numeric(substr(x, 58,61))
}
clim <- rast(x)
clim <- terra::crop(clim,dam, snap = "out")
clim <- data.frame(as.matrix(clim))
clim <- cbind(month, year, clim)
colnames(clim)[3] <- climvar
return(clim)
}
prec <- lapply(X = yearly_prec, FUN = rasttodf, dam = dam, climvar = "prec")
tmax <- lapply(X = yearly_tmax, FUN = rasttodf, dam = dam, climvar = "tmax")
tmin <- lapply(X = yearly_tmin, FUN = rasttodf, dam = dam, climvar = "tmin")
rasttodf <- function(x, dam, climvar = climvar) {
if(climvar == "ndvi"){
month <- as.numeric(substr(x, 94,95))
year <- as.numeric(substr(x, 90,93))
}
if(climvar %in% c("prec","tmax")) {
month <- as.numeric(substr(x, 62,63))
year <- as.numeric(substr(x, 57,60))
}
if(climvar == "tmin") {
month <- as.numeric(substr(x, 63,64))
year <- as.numeric(substr(x, 58,61))
}
clim <- rast(x)
clim <- terra::crop(clim,dam, snap = "out")
clim <- data.frame(as.matrix(clim))
clim <- cbind(month, year, clim)
colnames(clim)[3] <- climvar
return(clim)
}
prec <- lapply(X = yearly_prec, FUN = rasttodf, dam = dam, climvar = "prec")
tmax <- lapply(X = yearly_tmax, FUN = rasttodf, dam = dam, climvar = "tmax")
tmin <- lapply(X = yearly_tmin, FUN = rasttodf, dam = dam, climvar = "tmin")
lstodf <- function(x) {
df <- x[[1]]
i <- 2
while(i <= length(x)){
df <- rbind(df, x[[i]])
i <- i +1
}
return(df)
}
prec <- lstodf(prec)
tmin <- lstodf(tmin)
tmax <- lstodf(tmax)
clim <- cbind(prec, tmin$tmin, tmax$tmax)
colnames(clim)[4:5] <- c("tmin", "tmax")
clim <- clim %>% mutate(tran = tmax - tmin,
tmid = tmin + (tran/2),
pixel = rep(1:(nrow(clim) / length(unique(clim$year)) / 12),
length(unique(clim$year))*12)
) %>% group_by(pixel) %>%
mutate(tmid_lag = tmid - lag(tmid, n = 1),
prec_lag = prec - lag(prec, n = 1))
clim$tmid_lag[clim$month == 1]
mean(clim$tmid_lag[clim$month == 1])
mean(clim$tmid_lag[clim$month == 1], na.rm = T)
clim$prec_lag[is.na(clim$prec_lag)] <- mean(clim$prec_lag[clim$month == 1], na.rm = T)
View(clim)
clim$tmid_lag[is.na(clim$tmid_lag)] <- mean(clim$tmid_lag[clim$month == 1], na.rm = T)
vars <- data.frame(scale(clim[c(3:6, 9:10)]))
View(vars)
k <- 2:6
silhouette_score <- function(k){
km <- kmeans(vars, centers = k, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
avg_sil <- sapply(k, silhouette_score)
avg_sil
ggplot(clim) +
geom_col(aes(x = mont, y = tmid_lag))
ggplot(clim) +
geom_col(aes(x = mont, y = tmid_lag))
library(ggplot2)
ggplot(clim) +
geom_col(aes(x = mont, y = tmid_lag))
ggplot(clim) +
geom_col(aes(x = month, y = tmid_lag))
ggplot(clim) +
geom_point(aes(x = month, y = tmid_lag))
ggplot(clim) +
geom_point(aes(x = month, y = prec_lag))
vars <- data.frame(scale(clim[c(3:6, 9)]))
k <- 2:6
silhouette_score <- function(k){
km <- kmeans(vars, centers = k, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
vars <- data.frame(scale(clim[c(3,6,7,9)]))
k <- 2:6
silhouette_score <- function(k){
km <- kmeans(vars, centers = k, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
avg_sil <- sapply(k, silhouette_score)
avg_sil
vars <- data.frame(clim[c(3,6,7,9)])
k <- 2:6
silhouette_score <- function(k){
km <- kmeans(vars, centers = k, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
avg_sil <- sapply(k, silhouette_score)
avg_sil
vars <- data.frame(scale(clim[c(3,6,7,9)]))
k <- 2:6
silhouette_score <- function(k){
km <- kmeans(vars, centers = k, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
avg_sil <- sapply(k, silhouette_score)
avg_sil
dams <- read_sf("/home/chris/Documents/data/dams/selecteddams.shp")
dam <- dplyr::filter(dams, name == "Tehri")
rasttodf <- function(x, dam, climvar = climvar) {
if(climvar == "ndvi"){
month <- as.numeric(substr(x, 94,95))
year <- as.numeric(substr(x, 90,93))
}
if(climvar %in% c("prec","tmax")) {
month <- as.numeric(substr(x, 62,63))
year <- as.numeric(substr(x, 57,60))
}
if(climvar == "tmin") {
month <- as.numeric(substr(x, 63,64))
year <- as.numeric(substr(x, 58,61))
}
clim <- rast(x)
clim <- terra::crop(clim,dam, snap = "out")
clim <- data.frame(as.matrix(clim))
clim <- cbind(month, year, clim)
colnames(clim)[3] <- climvar
return(clim)
}
prec <- lapply(X = yearly_prec, FUN = rasttodf, dam = dam, climvar = "prec")
tmax <- lapply(X = yearly_tmax, FUN = rasttodf, dam = dam, climvar = "tmax")
tmin <- lapply(X = yearly_tmin, FUN = rasttodf, dam = dam, climvar = "tmin")
lstodf <- function(x) {
df <- x[[1]]
i <- 2
while(i <= length(x)){
df <- rbind(df, x[[i]])
i <- i +1
}
return(df)
}
prec <- lstodf(prec)
tmin <- lstodf(tmin)
tmax <- lstodf(tmax)
clim <- cbind(prec, tmin$tmin, tmax$tmax)
colnames(clim)[4:5] <- c("tmin", "tmax")
clim <- clim %>% mutate(tran = tmax - tmin,
tmid = tmin + (tran/2),
pixel = rep(1:(nrow(clim) / length(unique(clim$year)) / 12),
length(unique(clim$year))*12)
) %>% group_by(pixel) %>%
mutate(tmid_lag = tmid - lag(tmid, n = 1),
prec_lag = prec - lag(prec, n = 1))
clim$tmid_lag[is.na(clim$tmid_lag)] <- mean(clim$tmid_lag[clim$month == 1], na.rm = T)
clim$prec_lag[is.na(clim$prec_lag)] <- mean(clim$prec_lag[clim$month == 1], na.rm = T)
vars <- data.frame(scale(clim[c(3,6,7,9)]))
k <- 2:6
silhouette_score <- function(k){
km <- kmeans(vars, centers = k, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
avg_sil <- sapply(k, silhouette_score)
avg_sil
kmeans(vars, centers = 3)
cs <- kmeans(vars, centers = 3)$cluster
table(clim$month, cs)
View(vars)
vars <- data.frame(scale(clim[c(3,6,7,9)]))
vars$prec <- vars$prec * 3
silhouette_score <- function(k){
km <- kmeans(vars, centers = k, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
avg_sil <- sapply(k, silhouette_score)
avg_sil
vars <- data.frame(scale(clim[c(3,6,7,9)]))
vars$prec <- vars$prec * 2
k <- 2:6
silhouette_score <- function(k){
km <- kmeans(vars, centers = k, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
avg_sil <- sapply(k, silhouette_score)
avg_sil
vars <- data.frame(scale(clim[c(3,6,7,9)]))
vars$prec <- vars$prec
k <- 2:6
silhouette_score <- function(k){
km <- kmeans(vars, centers = k, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
avg_sil <- sapply(k, silhouette_score)
avg_sil
avg_sil
which(avg_sil, max)
?which
which(avg_sil == max(avg_sil))
which(avg_sil == max(avg_sil)) + 1
table(clim$month, cs)
dam <- read_sf("/home/chris/Documents/districts_1902_27700.shp")
rasttodf <- function(x, dam, climvar = climvar) {
if(climvar == "ndvi"){
month <- as.numeric(substr(x, 94,95))
year <- as.numeric(substr(x, 90,93))
}
if(climvar %in% c("prec","tmax")) {
month <- as.numeric(substr(x, 62,63))
year <- as.numeric(substr(x, 57,60))
}
if(climvar == "tmin") {
month <- as.numeric(substr(x, 63,64))
year <- as.numeric(substr(x, 58,61))
}
clim <- rast(x)
clim <- terra::crop(clim,dam, snap = "out")
clim <- data.frame(as.matrix(clim))
clim <- cbind(month, year, clim)
colnames(clim)[3] <- climvar
return(clim)
}
prec <- lapply(X = yearly_prec, FUN = rasttodf, dam = dam, climvar = "prec")
yearly_prec <- list.files("/home/chris/Documents/data/climate/prec", full.names = T)
yearly_prec <- as.list(yearly_prec)
yearly_tmax <- list.files("/home/chris/Documents/data/climate/tmax", full.names = T)
yearly_tmax <- as.list(yearly_tmax)
yearly_tmin <- list.files("/home/chris/Documents/data/climate/tmin/", full.names = T)
yearly_tmin <- as.list(yearly_tmin)
plot(dam)
climvar <- "prec"
rasttodf <- function(x, dam, climvar = climvar) {
if(climvar == "ndvi"){
month <- as.numeric(substr(x, 94,95))
year <- as.numeric(substr(x, 90,93))
}
if(climvar %in% c("prec","tmax")) {
month <- as.numeric(substr(x, 62,63))
year <- as.numeric(substr(x, 57,60))
}
if(climvar == "tmin") {
month <- as.numeric(substr(x, 63,64))
year <- as.numeric(substr(x, 58,61))
}
clim <- rast(x)
clim <- terra::crop(clim,dam, snap = "out")
clim <- data.frame(as.matrix(clim))
clim <- cbind(month, year, clim)
colnames(clim)[3] <- climvar
return(clim)
}
prec <- lapply(X = yearly_prec, FUN = rasttodf, dam = dam, climvar = "prec")
crs(dam)
dam <- read_sf("/home/chris/Documents/districts_1902_27700.shp") %>% st_transform(4326)
crs(dam)
rasttodf <- function(x, dam, climvar = climvar) {
if(climvar == "ndvi"){
month <- as.numeric(substr(x, 94,95))
year <- as.numeric(substr(x, 90,93))
}
if(climvar %in% c("prec","tmax")) {
month <- as.numeric(substr(x, 62,63))
year <- as.numeric(substr(x, 57,60))
}
if(climvar == "tmin") {
month <- as.numeric(substr(x, 63,64))
year <- as.numeric(substr(x, 58,61))
}
clim <- rast(x)
clim <- terra::crop(clim,dam, snap = "out")
clim <- data.frame(as.matrix(clim))
clim <- cbind(month, year, clim)
colnames(clim)[3] <- climvar
return(clim)
}
prec <- lapply(X = yearly_prec, FUN = rasttodf, dam = dam, climvar = "prec")
tmax <- lapply(X = yearly_tmax, FUN = rasttodf, dam = dam, climvar = "tmax")
tmin <- lapply(X = yearly_tmin, FUN = rasttodf, dam = dam, climvar = "tmin")
lstodf <- function(x) {
df <- x[[1]]
i <- 2
while(i <= length(x)){
df <- rbind(df, x[[i]])
i <- i +1
}
return(df)
}
prec <- lstodf(prec)
tmin <- lstodf(tmin)
tmax <- lstodf(tmax)
clim <- cbind(prec, tmin$tmin, tmax$tmax)
colnames(clim)[4:5] <- c("tmin", "tmax")
clim <- clim %>% mutate(tran = tmax - tmin,
tmid = tmin + (tran/2),
pixel = rep(1:(nrow(clim) / length(unique(clim$year)) / 12),
length(unique(clim$year))*12)
) %>% group_by(pixel) %>%
mutate(tmid_lag = tmid - lag(tmid, n = 1),
prec_lag = prec - lag(prec, n = 1))
clim$tmid_lag[is.na(clim$tmid_lag)] <- mean(clim$tmid_lag[clim$month == 1], na.rm = T)
clim$prec_lag[is.na(clim$prec_lag)] <- mean(clim$prec_lag[clim$month == 1], na.rm = T)
vars <- data.frame(scale(clim[c(3,6,7,9)]))
vars$prec <- vars$prec
krange <- 2:6
silhouette_score <- function(k){
km <- kmeans(vars, centers = krange, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
avg_sil <- sapply(k, silhouette_score)
View(vars)
vars <- data.frame(scale(clim[c(3,6,7,9)])) %>% drop_na()
library(tidyverse)
vars <- data.frame(scale(clim[c(3,6,7,9)])) %>% drop_na()
krange <- 2:6
silhouette_score <- function(k){
km <- kmeans(vars, centers = krange, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
avg_sil <- sapply(k, silhouette_score)
km <- kmeans(vars, centers = 2, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
km <- kmeans(vars, centers = 3, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
km <- kmeans(vars, centers = 4, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
km <- kmeans(vars, centers = 5, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
km <- kmeans(vars, centers = 6, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
avg_sil <- sapply(krange, silhouette_score)
krange <- 2:6
silhouette_score <- function(k){
km <- kmeans(vars, centers = krange, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
avg_sil <- sapply(krange, silhouette_score)
silhouette_score <- function(x){
km <- kmeans(vars, centers = x, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
avg_sil <- sapply(krange, silhouette_score)
k <- which(avg_sil == max(avg_sil)) + 1
avg_sil <- sapply(krange, silhouette_score)
avg_sil
View(vars)
View(clim)
clim <- cbind(prec, tmin$tmin, tmax$tmax)
View(clim)
clim <- cbind(prec, tmin$tmin, tmax$tmax) %>% drop_na()
colnames(clim)[4:5] <- c("tmin", "tmax")
clim <- clim %>% mutate(tran = tmax - tmin,
tmid = tmin + (tran/2),
pixel = rep(1:(nrow(clim) / length(unique(clim$year)) / 12),
length(unique(clim$year))*12)
) %>% group_by(pixel) %>%
mutate(tmid_lag = tmid - lag(tmid, n = 1),
prec_lag = prec - lag(prec, n = 1))
clim$tmid_lag[is.na(clim$tmid_lag)] <- mean(clim$tmid_lag[clim$month == 1], na.rm = T)
clim$prec_lag[is.na(clim$prec_lag)] <- mean(clim$prec_lag[clim$month == 1], na.rm = T)
vars <- data.frame(scale(clim[c(3,6,7,9)])) %>% drop_na()
krange <- 2:6
silhouette_score <- function(x){
km <- kmeans(vars, centers = x, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
avg_sil <- sapply(krange, silhouette_score)
avg_sil
table(clim$month, cs)
k <- which(avg_sil == max(avg_sil)) + 1
cs <- kmeans(vars, centers = 3)$cluster
cs <- kmeans(vars, centers = 4)$cluster
table(clim$month, cs)
cs <- kmeans(vars, centers = 2)$cluster
table(clim$month, cs)
krange <- 3:6
silhouette_score <- function(x){
km <- kmeans(vars, centers = x, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
avg_sil <- sapply(krange, silhouette_score)
avg_sil
k <- which(avg_sil == max(avg_sil)) + 1
k <- which(avg_sil == max(avg_sil)) + 2
avg_sil
dams <- read_sf("/home/chris/Documents/data/dams/selecteddams.shp")
dam <- dplyr::filter(dams, name == "Tehri")
rasttodf <- function(x, dam, climvar = climvar) {
if(climvar == "ndvi"){
month <- as.numeric(substr(x, 94,95))
year <- as.numeric(substr(x, 90,93))
}
if(climvar %in% c("prec","tmax")) {
month <- as.numeric(substr(x, 62,63))
year <- as.numeric(substr(x, 57,60))
}
if(climvar == "tmin") {
month <- as.numeric(substr(x, 63,64))
year <- as.numeric(substr(x, 58,61))
}
clim <- rast(x)
clim <- terra::crop(clim,dam, snap = "out")
clim <- data.frame(as.matrix(clim))
clim <- cbind(month, year, clim)
colnames(clim)[3] <- climvar
return(clim)
}
prec <- lapply(X = yearly_prec, FUN = rasttodf, dam = dam, climvar = "prec")
tmax <- lapply(X = yearly_tmax, FUN = rasttodf, dam = dam, climvar = "tmax")
tmin <- lapply(X = yearly_tmin, FUN = rasttodf, dam = dam, climvar = "tmin")
lstodf <- function(x) {
df <- x[[1]]
i <- 2
while(i <= length(x)){
df <- rbind(df, x[[i]])
i <- i +1
}
return(df)
}
prec <- lstodf(prec)
tmin <- lstodf(tmin)
tmax <- lstodf(tmax)
clim <- cbind(prec, tmin$tmin, tmax$tmax) %>% drop_na()
colnames(clim)[4:5] <- c("tmin", "tmax")
clim <- clim %>% mutate(tran = tmax - tmin,
tmid = tmin + (tran/2),
pixel = rep(1:(nrow(clim) / length(unique(clim$year)) / 12),
length(unique(clim$year))*12)
) %>% group_by(pixel) %>%
mutate(tmid_lag = tmid - lag(tmid, n = 1),
prec_lag = prec - lag(prec, n = 1))
clim$tmid_lag[is.na(clim$tmid_lag)] <- mean(clim$tmid_lag[clim$month == 1], na.rm = T)
clim$prec_lag[is.na(clim$prec_lag)] <- mean(clim$prec_lag[clim$month == 1], na.rm = T)
vars <- data.frame(scale(clim[c(3,6,7,9)])) %>% drop_na()
krange <- 3:6
silhouette_score <- function(x){
km <- kmeans(vars, centers = x, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
avg_sil <- sapply(krange, silhouette_score)
avg_sil
krange <- 2:6
silhouette_score <- function(x){
km <- kmeans(vars, centers = x, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
avg_sil <- sapply(krange, silhouette_score)
avg_sil
krange <- 2:4
silhouette_score <- function(x){
km <- kmeans(vars, centers = x, nstart=25)
ss <- silhouette(km$cluster, dist(vars))
mean(ss[, 3])
}
avg_sil <- sapply(krange, silhouette_score)
avg_sil
